name: Psych Engine Android Build

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    env:
      ANDROID_HOME: /home/runner/android
      ANDROID_SDK: /home/runner/android
      ANDROID_NDK_ROOT: /home/runner/android/ndk
      JAVA_HOME: /usr/lib/jvm/java-17-openjdk-amd64
      HAXELIB_ROOT: /home/runner/.haxelib

    steps:
    - name: Clone source code
      run: |
        git clone "${{ github.server_url }}/${{ github.repository }}" source
        cd source
        git checkout "${{ github.ref_name }}"

    - name: Install Android SDK & NDK
      run: |
        mkdir -p $ANDROID_HOME/cmdline-tools
        wget https://dl.google.com/android/repository/commandlinetools-linux-11076708_latest.zip -O sdk.zip
        unzip sdk.zip -d $ANDROID_HOME/cmdline-tools
        mv $ANDROID_HOME/cmdline-tools/cmdline-tools $ANDROID_HOME/cmdline-tools/tools
        yes | $ANDROID_HOME/cmdline-tools/tools/bin/sdkmanager --licenses
        $ANDROID_HOME/cmdline-tools/tools/bin/sdkmanager "platform-tools" "platforms;android-30" "build-tools;30.0.3" "ndk;21.4.7075529"
        mv $ANDROID_HOME/ndk/21.4.7075529 $ANDROID_NDK_ROOT

    - name: Install Haxe & Haxelib
      run: |
        mkdir -p ~/haxe-tmp
        wget https://github.com/HaxeFoundation/haxe/releases/download/4.3.3/haxe-4.3.3-linux64.tar.gz
        tar -xzf haxe-4.3.3-linux64.tar.gz -C ~/haxe-tmp
        FOLDER=$(find ~/haxe-tmp -type d -name "haxe*")
        sudo cp $FOLDER/haxe /usr/local/bin/haxe
        sudo cp $FOLDER/haxelib /usr/local/bin/haxelib
        haxelib setup ~/.haxelib

    - name: Install Haxelibs (Split)
      run: |
        haxelib install lime 8.0.2
        haxelib install openfl 9.2.2
        haxelib install flixel
        haxelib install flixel-addons
        haxelib install flixel-ui
        haxelib install hxcpp
        haxelib install hscript
        haxelib install tjson
        haxelib install linc_luajit
        haxelib install extension-webview

    - name: Link Libraries
      run: |
        haxelib run lime setup --skip-visual
        haxelib run lime setup android

    - name: Build APK
      run: |
        cd source
        haxelib run lime build android -final -D MODS_ALLOWED -D NO_PRELOAD_ALL

    - name: Copy APK to Output
      run: |
        mkdir -p output
        cp source/export/release/android/bin/app-release.apk output/PsychEngine.apk
