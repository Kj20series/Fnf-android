name: Build Psych Engine Android

on: [push, pull_request, workflow_dispatch]

jobs:
  buildAndroid:
    name: Build Psych Engine Android
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Android NDK
        uses: nttld/setup-ndk@v1
        id: setup-ndk
        with:
          ndk-version: r21e

      - name: Setup Java 17 (needed by sdkmanager)
        uses: actions/setup-java@v1
        with:
          java-version: 17

      - name: Install Android SDK components
        run: |
          yes | $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --licenses
          $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager \
            "platform-tools" \
            "platforms;android-33" \
            "build-tools;33.0.2" \
            "ndk;21.4.7075529"

      - name: Setup Haxe
        uses: krdlab/setup-haxe@v1.1.5
        with:
          haxe-version: 4.2.5

      - name: Setup Haxelib directory
        run: haxelib setup ~/haxelib

      - name: Install lime
        run: haxelib install lime 7.9.0

      - name: Install openfl
        run: haxelib install openfl 8.9.7

      - name: Install flixel
        run: haxelib install flixel

      - name: Install flixel-ui
        run: haxelib install flixel-ui

      - name: Install flixel-addons
        run: haxelib install flixel-addons

      - name: Install hscript
        run: haxelib install hscript

      - name: Install flixel-tools
        run: haxelib install flixel-tools

      - name: Install actuate
        run: haxelib install actuate

      - name: Install hxCodec
        run: haxelib install hxCodec

      - name: Install linc_luajit
        run: haxelib git linc_luajit https://github.com/MAJigsaw77/linc_luajit

      - name: Install extension-androidtools
        run: haxelib git extension-androidtools https://github.com/MAJigsaw77/extension-androidtools

      - name: Install extension-webview
        run: haxelib git extension-webview https://github.com/Daninnocent/extension-webview.git

      - name: Setup Lime + Android config
        run: |
          haxelib run lime setup -alias -y
          haxelib run lime config ANDROID_SDK $ANDROID_HOME
          haxelib run lime config ANDROID_NDK_ROOT $ANDROID_NDK_HOME
          haxelib run lime config JAVA_HOME $JAVA_HOME
          haxelib run lime config ANDROID_SETUP true
        env:
          ANDROID_NDK_HOME: ${{ steps.setup-ndk.outputs.ndk-path }}

      - name: Build APK
        run: |
          echo "${{ github.run_id }}" > VERSION
          haxelib run lime build android

      - name: Upload APK Artifact
        uses: actions/upload-artifact@v4
        with:
          name: PsychEngine-Android-APK
          path: export/debug/android/bin/app/build/outputs/apk/debug/*.apk
